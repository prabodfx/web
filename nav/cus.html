<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Categorizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Poppins', sans-serif; 
      background: #0d1117;
      color: #c9d1d9;
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container { 
      max-width: 1000px; 
      width: 100%;
      margin: 0 auto;
      padding: 2rem; 
      background: #161b22;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .message-box {
      position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
      padding: 1rem 2rem; border-radius: .75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 1000; display: none; opacity: 0; transition: opacity .4s ease-in-out;
      font-weight: 500;
    }
    .input-container {
      display: flex;
      align-items: center; 
      gap: 0.75rem;
    }
    .input-container textarea {
      line-height: 36px;
      min-height: 48px; 
      max-height: 200px;
      padding: 0.75rem 1rem;
      resize: none; 
      overflow-y: auto;
    }
    .input-container button {
      height: 48px;
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .save-dialog, .delete-dialog {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #21262d; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.7);
      z-index: 2000; display: none;
      width: 90%; max-width: 400px;
    }
    .save-dialog input {
      width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #30363d;
      background: #0d1117; color: #c9d1d9;
    }
    .save-dialog button, .delete-dialog button {
      padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;
    }
    #savedDataList {
        display: none;
        margin-top: 1rem;
    }
    .search-bar-container {
        display: none;
        margin-bottom: 1rem;
    }
    .search-bar-container input {
        width: 100%;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background: #161b22;
        color: #c9d1d9;
        border: 1px solid #30363d;
    }
    .hidden-by-shift {
      display: none !important;
    }
    .content-section {
      margin-bottom: 2rem;
    }
    .results-row td {
        cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-950 text-gray-300">
  <div class="container mx-4 md:mx-auto">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">BILL <b class="text-blue-400">SAVER</b></h1>
    </header>

    <div class="space-y-8">
      <div id="inputControls" class="hidden-by-shift">
        <div class="input-container w-full">
          <textarea id="dataInput" rows="1" placeholder="Paste your data here..." class="w-full border border-gray-700 rounded-xl bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner"></textarea>
          <button id="processBtn" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
            Process
          </button>
        </div>
      </div>
      
      <div class="content-section">
        <div id="savedDataList" class="bg-gray-800 p-6 rounded-lg shadow-inner">
          <h1 class="text-xl font-semibold mb-4 text-white">Saved Datasets</h1>
          <div id="searchContainer" class="search-bar-container">
              <input type="text" id="searchBar" placeholder="Search saved datasets..." />
          </div>
          <ul id="savesList" class="space-y-2"></ul>
        </div>
      </div>

      <div class="content-section">
        <h2 class="text-3xl font-semibold text-gray-200 mb-6">Categorized Data</h2>
        <div id="resultsTableContainer" class="overflow-hidden rounded-2xl shadow-xl border border-gray-700">
          <table class="min-w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="py-4 px-6 text-left text-sm font-semibold text-gray-400 uppercase tracking-wider">Item Code</th>
                <th class="py-4 px-6 text-left text-sm font-semibold text-gray-400 uppercase tracking-wider">Quantity</th>
                <th class="py-4 px-6 text-left text-sm font-semibold text-gray-400 uppercase tracking-wider">Rate</th>
              </tr>
            </thead>
            <tbody id="resultsTableBody" class="bg-gray-800 divide-y divide-gray-700"></tbody>
          </table>
        </div>
        <div id="noResults" class="text-center text-gray-500 p-8 text-lg" style="display:block;">No data to display. Paste some data to get started.</div>
      </div>
    </div>

    <div id="saveDialog" class="save-dialog">
      <h3 class="text-xl font-bold mb-4 text-white">Save Processed Data</h3>
      <p class="mb-2">Enter a name for this dataset:</p>
      <input type="text" id="saveNameInput" class="mb-4" placeholder="e.g., 'Weekly Sales Report'"/>
      <div class="flex justify-end gap-2">
        <button id="cancelSaveBtn" class="bg-gray-600 text-white hover:bg-gray-500">Cancel</button>
        <button id="confirmSaveBtn" class="bg-blue-600 text-white hover:bg-blue-500">Save</button>
      </div>
    </div>
    
    <div id="deleteDialog" class="delete-dialog">
        <h3 class="text-xl font-bold mb-4 text-white">Delete Dataset</h3>
        <p class="mb-4">Are you sure you want to delete <strong id="deleteDatasetName"></strong>?</p>
        <div class="flex justify-end gap-2">
            <button id="cancelDeleteBtn" class="bg-gray-600 text-white hover:bg-gray-500">Cancel</button>
            <button id="confirmDeleteBtn" class="bg-red-600 text-white hover:bg-red-500">Delete</button>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>
  </div>

  <script>
    function showMessage(message, type = 'success') {
      const el = document.getElementById('messageBox');
      el.textContent = message;
      el.className = 'message-box';
      el.classList.add(
        type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800',
        'text-white'
      );
      el.style.display = 'block';
      requestAnimationFrame(() => el.style.opacity = '1');
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 400); }, 3000);
    }

    const numStrToFloat = (s) => parseFloat(String(s).replace(/,/g, ''));
    const looksNumeric = (s) => {
      if (!s && s !== 0) return false;
      const t = String(s).replace(/,/g, '');
      return /^[-+]?\d+(\.\d+)?$/.test(t);
    };
    const isAllCapsShort = (s) => /^[A-Z]{1,4}$/.test(s);

    function displayData(data) {
      const tbody = document.getElementById('resultsTableBody');
      const noResults = document.getElementById('noResults');
      tbody.innerHTML = '';

      if (data && data.length) {
        noResults.style.display = 'none';
        data.forEach((it, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-700 transition-colors duration-200 results-row';
          if (index % 2 === 0) {
            tr.classList.add('bg-gray-900');
          }
          tr.innerHTML = `
            <td class="py-4 px-6 text-gray-300 font-medium">${it.itemCode}</td>
            <td class="py-4 px-6 text-gray-300">${it.quantity}</td>
            <td class="py-4 px-6 text-gray-300">${it.rate}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        noResults.style.display = 'block';
      }
    }

    let lastProcessedData = null; 

    function processData() {
      const raw = document.getElementById('dataInput').value || '';
      const rows = raw.split('\n').map(l => l.trim()).filter(Boolean);
      const processed = [];

      rows.forEach(line => {
        let tokens = line.split(/\s+/).filter(Boolean);
        if (!tokens.length) return;

        let hadSerialAtStart = false;
        if (looksNumeric(tokens[0]) && Number.isInteger(numStrToFloat(tokens[0]))) {
          hadSerialAtStart = true;
          tokens.shift();
        }

        let itemCode = '';
        let searchStart = 0;

        if (hadSerialAtStart) {
          if (tokens.length === 0) return;
          let parts = [tokens[0]];
          let i = 1;
          while (i < tokens.length && isAllCapsShort(tokens[i])) {
            parts.push(tokens[i]);
            i++;
          }
          itemCode = parts.join(' ').trim();
          searchStart = i;
        } else {
          let iCodeIdx = -1;
          for (let i = 0; i < tokens.length; i++) {
            if (!looksNumeric(tokens[i])) {
              itemCode = tokens[i];
              iCodeIdx = i;
              if (tokens[i + 1] && isAllCapsShort(tokens[i + 1])) {
                itemCode += ' ' + tokens[i + 1];
                iCodeIdx = i + 1;
              }
              break;
            }
          }
          searchStart = (iCodeIdx >= 0) ? iCodeIdx + 1 : 0;
        }

        if (!itemCode) return;

        let zeroIdx = -1;
        for (let i = searchStart; i < tokens.length; i++) {
          if (looksNumeric(tokens[i]) && Math.abs(numStrToFloat(tokens[i]) - 0) < 1e-9) {
            zeroIdx = i;
            break;
          }
        }

        let qty = 'N/A';
        let rate = 'N/A';

        if (zeroIdx >= 0) {
          let qIdx = -1;
          for (let j = zeroIdx + 1; j < tokens.length; j++) {
            if (looksNumeric(tokens[j])) {
              const v = numStrToFloat(tokens[j]);
              if (!isNaN(v) && v >= 0) {
                qty = tokens[j];
                qIdx = j;
                break;
              }
            }
          }
          if (qIdx >= 0) {
            for (let k = qIdx + 1; k < tokens.length; k++) {
              if (looksNumeric(tokens[k])) {
                rate = tokens[k];
                break;
              }
            }
          }
        } else {
          let qIdx = -1;
          for (let i = searchStart; i < tokens.length; i++) {
            if (looksNumeric(tokens[i])) {
              const v = numStrToFloat(tokens[i]);
              if (!isNaN(v)) {
                qty = tokens[i];
                qIdx = i;
                break;
              }
            }
          }
          if (qIdx >= 0) {
            for (let k = qIdx + 1; k < tokens.length; k++) {
              if (looksNumeric(tokens[k])) {
                rate = tokens[k];
                break;
              }
            }
          }
        }

        processed.push({ itemCode, quantity: qty, rate });
      });

      lastProcessedData = processed;
      displayData(processed);
      if (processed.length) {
        showMessage('Data processed successfully.', 'success');
      } else {
        showMessage('No valid data found.', 'error');
      }
    }
    
    function autoSaveProcessedData(name) {
        if (!lastProcessedData || lastProcessedData.length === 0) {
            return;
        }

        let savedData = JSON.parse(localStorage.getItem('categorizedDatasets') || '{}');
        savedData[name] = lastProcessedData;
        
        try {
            localStorage.setItem('categorizedDatasets', JSON.stringify(savedData));
            loadSavedDatasetsList();
        } catch (e) {
            console.error("Local storage save failed:", e);
        }
    }

    function saveProcessedData() {
        if (!lastProcessedData || lastProcessedData.length === 0) {
            showMessage('No data to save. Process some data first.', 'error');
            return;
        }
        document.getElementById('saveDialog').style.display = 'block';
        document.getElementById('saveNameInput').focus(); // Automatically focus the input
    }

    function confirmSave() {
        const saveName = document.getElementById('saveNameInput').value.trim();
        if (!saveName) {
            showMessage('Please enter a name for the dataset.', 'error');
            return;
        }
        
        let savedData = JSON.parse(localStorage.getItem('categorizedDatasets') || '{}');
        const newDataString = JSON.stringify(lastProcessedData);

        for (const key in savedData) {
            if (JSON.stringify(savedData[key]) === newDataString) {
                delete savedData[key];
            }
        }

        savedData[saveName] = lastProcessedData;
        
        try {
            localStorage.setItem('categorizedDatasets', JSON.stringify(savedData));
            showMessage(`Dataset "${saveName}" saved successfully.`, 'success');
            document.getElementById('saveDialog').style.display = 'none';
            document.getElementById('saveNameInput').value = '';
            loadSavedDatasetsList();
        } catch (e) {
            showMessage('Error saving data to local storage.', 'error');
            console.error("Local storage save failed:", e);
        }
    }

    function cancelSave() {
        document.getElementById('saveDialog').style.display = 'none';
    }

    function deleteDataset(name) {
        let savedData = JSON.parse(localStorage.getItem('categorizedDatasets') || '{}');
        if (savedData.hasOwnProperty(name)) {
            delete savedData[name];
            localStorage.setItem('categorizedDatasets', JSON.stringify(savedData));
            showMessage(`Dataset "${name}" deleted successfully.`, 'success');
            loadSavedDatasetsList(); 
        } else {
            showMessage('Error: Dataset not found.', 'error');
        }
    }

    function loadSavedDatasetsList(filter = '') {
        const savesList = document.getElementById('savesList');
        savesList.innerHTML = '';
        const savedData = JSON.parse(localStorage.getItem('categorizedDatasets') || '{}');
        const names = Object.keys(savedData);

        const filteredNames = names.filter(name => name.toLowerCase().includes(filter.toLowerCase()));

        if (filteredNames.length === 0) {
            savesList.innerHTML = '<li class="text-center text-gray-500">No saved datasets found.</li>';
        } else {
            filteredNames.forEach(name => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-md hover:bg-gray-600 transition-colors cursor-pointer';
                li.innerHTML = `<span>${name}</span>`;
                li.dataset.name = name; 
                savesList.appendChild(li);
            });
        }
    }
    
    function handleLoadRequest(event) {
        const li = event.target.closest('li');
        if (li && li.dataset.name) {
            const name = li.dataset.name;
            const savedData = JSON.parse(localStorage.getItem('categorizedDatasets') || '{}');
            const dataToLoad = savedData[name];
            if (dataToLoad) {
                displayData(dataToLoad);
                showMessage(`Loaded dataset "${name}".`, 'success');
                document.getElementById('savedDataList').style.display = 'block';
                document.getElementById('searchContainer').style.display = 'block';
            } else {
                showMessage('Error: Dataset not found.', 'error');
            }
        }
    }

    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showMessage(`'${text}' copied to clipboard!`, 'success');
        } catch (err) {
            showMessage('Failed to copy to clipboard.', 'error');
        }
    }

    document.getElementById('processBtn').addEventListener('click', processData);
    document.getElementById('confirmSaveBtn').addEventListener('click', confirmSave);
    document.getElementById('cancelSaveBtn').addEventListener('click', cancelSave);
    document.getElementById('savesList').addEventListener('click', handleLoadRequest);
    document.getElementById('searchBar').addEventListener('input', (e) => {
        loadSavedDatasetsList(e.target.value);
    });
    
    document.getElementById('saveNameInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            confirmSave();
        }
    });

    const dataInput = document.getElementById('dataInput');
    dataInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    dataInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        processData();
      }
    });

    document.addEventListener('dblclick', async (e) => {
        const row = e.target.closest('#resultsTableBody tr');
        if (!row) {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    dataInput.value = text;
                    dataInput.style.height = 'auto';
                    dataInput.style.height = (dataInput.scrollHeight) + 'px';
                    processData();
                    const autoSaveName = `Auto-Save-${new Date().toISOString()}`;
                    autoSaveProcessedData(autoSaveName);
                    showMessage('Data pasted, processed, and auto-saved.', 'success');
                } else {
                    showMessage('Clipboard is empty.', 'error');
                }
            } catch (err) {
                showMessage('Clipboard access denied. Please manually paste.', 'error');
            }
        }
    });
    
    document.getElementById('resultsTableBody').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (row) {
            const itemCode = row.children[0].textContent;
            copyToClipboard(itemCode);
        }
    });

    document.getElementById('resultsTableBody').addEventListener('contextmenu', (e) => {
        e.preventDefault(); 
        const row = e.target.closest('tr');
        if (row) {
            const quantity = row.children[1].textContent;
            copyToClipboard(quantity);
        }
    });

    document.getElementById('resultsTableBody').addEventListener('dblclick', (e) => {
        const row = e.target.closest('tr');
        if (row) {
            const rate = row.children[2].textContent;
            copyToClipboard(rate);
        }
    });
    
    document.getElementById('savesList').addEventListener('dblclick', (e) => {
        const li = e.target.closest('li');
        if (li && li.dataset.name) {
            const name = li.dataset.name;
            document.getElementById('deleteDatasetName').textContent = name;
            document.getElementById('deleteDialog').dataset.name = name;
            document.getElementById('deleteDialog').style.display = 'block';
        }
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
        const name = document.getElementById('deleteDialog').dataset.name;
        deleteDataset(name);
        document.getElementById('deleteDialog').style.display = 'none';
    });
    
    document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
        document.getElementById('deleteDialog').style.display = 'none';
    });


    document.addEventListener('keydown', (e) => {
      const saveDialog = document.getElementById('saveDialog');
      const inputControls = document.getElementById('inputControls');
      const savedDataList = document.getElementById('savedDataList');
      const searchContainer = document.getElementById('searchContainer');
      const searchBar = document.getElementById('searchBar');
      const activeElement = document.activeElement;

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        inputControls.classList.toggle('hidden-by-shift');
      }

      if (e.key === 'ArrowDown') {
          e.preventDefault();
          const isHidden = searchContainer.style.display === 'none' || searchContainer.style.display === '';
          searchContainer.style.display = isHidden ? 'block' : 'none';
          if (isHidden) {
              searchBar.focus();
          } else {
              searchBar.blur();
          }
      }

      if (e.key === '+') {
          e.preventDefault();
          const isHidden = savedDataList.style.display === 'none' || savedDataList.style.display === '';
          savedDataList.style.display = isHidden ? 'block' : 'none';
          if (isHidden) {
              loadSavedDatasetsList();
          }
      }

      if (e.key === ' ' && saveDialog.style.display !== 'block') {
          if (activeElement !== dataInput) {
            e.preventDefault();
            saveProcessedData();
          }
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadSavedDatasetsList();
    });
  </script>
</body>
</html>
