<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reciept V2 | Prabodfx</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    /* Global Styles */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1f1c2c, #928dab);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #fff;
      transition: background 0.5s ease-in-out;
      overflow: hidden; /* Prevent body scrollbars */
    }

    /* Main container for both search and saved data sections */
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      width: 450px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: opacity 0.5s, transform 0.5s;
    }

    /* Style for the container when hidden */
    .container.hidden {
      opacity: 0;
      transform: scale(0.9);
      pointer-events: none;
      position: absolute;
    }

    /* Style to center a container on the screen */
    .container.center-on-screen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 1;
      pointer-events: auto;
    }

    /* Heading 1 style */
    h1 {
      font-size: 1.8rem;
      margin-bottom: 25px;
      font-weight: 300;
    }

    /* Input field styling */
    input[type="text"] {
      width: 80%;
      padding: 15px;
      margin-bottom: 20px;
      border: none;
      border-radius: 12px;
      outline: none;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      transition: all 0.3s ease;
      text-align: center;
    }

    /* Placeholder text color for the input field */
    input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Focus state for the input field */
    input[type="text"]:focus {
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
    }

    /* Button styling */
    button {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      background: #ff7eb3;
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
      transition: 0.3s;
      font-weight: 600;
      letter-spacing: 1px;
      margin: 5px;
    }

    /* Button hover effect */
    button:hover {
      background: #ff5277;
      transform: translateY(-2px);
    }
    
    .delete-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .delete-buttons button {
      background: #e74c3c;
      padding: 10px 15px;
      font-size: 0.9rem;
    }

    .delete-buttons button:hover {
      background: #c0392b;
    }

    /* Result box styling */
    .result {
      margin-top: 30px;
      font-size: 1.3rem;
      font-weight: bold;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      display: none;
      border-left: 4px solid #ff7eb3;
      white-space: pre-wrap; /* Preserve formatting */
      word-wrap: break-word; /* Prevent overflow */
    }

    /* Feedback text styling */
    .feedback {
      margin-top: 15px;
      font-size: 1rem;
      font-style: italic;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Saved data container styling */
    .saved-data-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      width: 800px; /* Wider for three columns */
      max-height: 80vh;
      overflow-y: auto;
      text-align: left;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: opacity 0.5s, transform 0.5s;
    }

    /* Heading 2 styling for saved data */
    .saved-data-container h2 {
      font-size: 1.8rem;
      font-weight: 300;
      text-align: center;
      margin-bottom: 20px;
    }
    
    /* Heading 3 for the date-based tables */
    .saved-data-container h3 {
      font-size: 1.5rem;
      font-weight: 300;
      text-align: center;
      margin-top: 30px;
    }

    /* Table styling within the saved data container */
    .saved-data-container table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    /* Table header and cell styling */
    .saved-data-container th, .saved-data-container td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Table header specific styling */
    .saved-data-container th {
      font-size: 1rem;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.2);
    }

    /* Row hover effect */
    .saved-data-container tr:hover {
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
    }

    /* Customer code highlight color */
    .customer-code {
      color: #ff7eb3;
    }
    
    /* Class for the normal marked color (blue-green) */
    .marked-row-1 {
      background: rgba(0, 255, 255, 0.2) !important;
    }

    /* Class for the special marked color (yellow) */
    .marked-row-2 {
      background: rgba(255, 255, 0, 0.2) !important;
    }

    /* Modal Overlay Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    /* Modal content styling */
    .modal-content {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 300px;
      transform: scale(0.95);
      transition: transform 0.3s ease-in-out;
      position: relative; /* Needed for the close button */
    }

    /* Modal show animation */
    .modal-content.show {
      transform: scale(1);
    }

    /* Modal input field styling */
    .modal-content input {
      width: 70%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
      font-size: 1.1rem;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Operation buttons container */
    .modal-content .op-buttons button {
      margin: 0 10px;
      width: 60px;
      padding: 12px;
      font-size: 1.5rem;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    /* Initial hidden state for operation buttons */
    .modal-content .op-buttons {
      display: none;
    }

    /* Close button style */
    .close-button {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #fff;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
      transition: color 0.2s;
    }

    .close-button:hover {
      color: #ff5277;
    }
  </style>
</head>
<body>

  <div class="container" id="searchContainer">
    <h1>Invoice Manager</h1>
    <p class="feedback" id="feedback-text">
        Drag & drop a PDF file anywhere on the page to begin.<br>
        Current numbering direction: <span id="directionIndicator">Decrement (-)</span>
    </p>
    <input type="text" id="invoiceInput" placeholder="Enter Invoice Number" autofocus>
    <br>
    <button onclick="searchInvoice()">Search</button>
    <div class="result" id="resultBox"></div>
  </div>

  <div class="container saved-data-container hidden" id="savedDataContainer">
    <h2 id="mainHeader">Saved Data</h2>
    <div class="delete-buttons">
      <button onclick="removeAllData()">Remove All Data</button>
      <button onclick="removeSelectedData()">Remove Selected Data</button>
      <button onclick="removeTodayData()">Remove Today's Data</button>
    </div>
  </div>
  
  <div class="modal-overlay" id="znModalOverlay">
    <div class="modal-content" id="znModalContent">
      <button class="close-button" onclick="closeModal()">Ã—</button>
      <h3 style="margin-top: 0;" id="modalHeading">Enter Receipt No</h3>
      <input type="text" id="znInput" placeholder="Type a number">
      <div class="op-buttons">
        <p>Choose an operation:</p>
        <button id="opPlus">+</button>
        <button id="opMinus">-</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables to store application state
    let customerData = {}; // Stores invoice data parsed from PDFs
    let znNumber = null; // Stores the current zn number for automatic numbering
    let lastOperation = '-'; // Default to decrementing
    let lastInvoiceNumber = null; // Stores the last searched invoice number for the formatted string
    let lastCustomerName = null; // Stores the last customer name
    let lastCustomerCode = null; // Stores the last customer code
    let savedSearchTerm = ''; // To save the exact search term for the saved section
    let activeRow = null; // Stores the single, most recently clicked row

    // DOM element references
    const feedbackText = document.getElementById('feedback-text');
    const directionIndicator = document.getElementById('directionIndicator');
    const searchContainer = document.getElementById('searchContainer');
    const savedDataContainer = document.getElementById('savedDataContainer');
    const invoiceInput = document.getElementById('invoiceInput');
    const mainHeader = document.getElementById('mainHeader');
    const resultBox = document.getElementById('resultBox');
    
    // Modal DOM elements
    const znModalOverlay = document.getElementById('znModalOverlay');
    const znModalContent = document.getElementById('znModalContent');
    const znInput = document.getElementById('znInput');
    const opButtonsContainer = document.querySelector('.op-buttons');
    const opPlusBtn = document.getElementById('opPlus');
    const opMinusBtn = document.getElementById('opMinus');
    const modalHeading = document.getElementById('modalHeading');

    /**
     * Initializes the application by loading data from local storage.
     * This function is called when the page first loads.
     */
    function loadFromLocalStorage() {
      // Load invoice data from the 'invoiceData' key in local storage
      const storedData = localStorage.getItem('invoiceData');
      if (storedData) {
        customerData = JSON.parse(storedData);
        feedbackText.innerHTML = `Data loaded from previous sessions.<br>Current numbering direction: <span id="directionIndicator">${lastOperation === '+' ? 'Increment (+)' : 'Decrement (-)'}</span>`;
      }
      
      // Load saved items for the table from the 'savedItems' key
      const savedItems = JSON.parse(localStorage.getItem('savedItems')) || {};
      renderSavedData(savedItems);
    }

    /**
     * Renders the saved data tables dynamically based on date.
     * It creates a new table for each date with saved entries.
     * @param {object} data - The data object containing saved entries organized by date.
     */
    function renderSavedData(data) {
      // Clear the existing content of the saved data container, except for the h2 and delete buttons
      savedDataContainer.querySelectorAll('h3, table').forEach(el => el.remove());
      
      // Sort the dates to display the most recent data first
      const sortedDates = Object.keys(data).sort((a, b) => new Date(b) - new Date(a));
      
      // Iterate through each date and create a new table
      sortedDates.forEach(date => {
        const tableHeader = document.createElement('h3');
        tableHeader.textContent = `Date: ${date}`;
        savedDataContainer.appendChild(tableHeader);
        
        const table = document.createElement('table');
        const tableHead = document.createElement('thead');
        tableHead.innerHTML = `
          <tr>
            <th>CUSTOMER CODE</th>
            <th>CUSTOMER NAME</th>
            <th>FORMAT</th>
          </tr>
        `;
        table.appendChild(tableHead);
        
        const tableBody = document.createElement('tbody');
        data[date].forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><span class="customer-code">${item.code}</span></td>
            <td>${item.name}</td>
            <td>${item.format}</td>
          `;
          // Check for the markType property and apply the corresponding class
          if (item.markType) {
            row.classList.add(item.markType);
          }
          // Add event listeners for row actions
          row.addEventListener('click', () => handleRowClick(row, item));
          row.addEventListener('contextmenu', (e) => handleRightClick(e, row, item));
          row.addEventListener('dblclick', () => handleRowDoubleClick(item));
          tableBody.appendChild(row);
        });
        table.appendChild(tableBody);
        savedDataContainer.appendChild(table);
      });
    }

    /**
     * Saves the `customerData` object to local storage.
     */
    function saveToLocalStorage() {
      localStorage.setItem('invoiceData', JSON.stringify(customerData));
    }

    /**
     * Saves the marking state of a row to local storage.
     * @param {object} item - The data item for the row.
     * @param {string} markType - The CSS class name for the mark ('marked-row-1', 'marked-row-2') or null to remove.
     */
    function saveMarkState(item, markType) {
        let savedItems = JSON.parse(localStorage.getItem('savedItems')) || {};
        const dates = Object.keys(savedItems);
        for (const date of dates) {
            const index = savedItems[date].findIndex(savedItem => 
                savedItem.code === item.code && 
                savedItem.name === item.name &&
                savedItem.format === item.format
            );
            if (index !== -1) {
                // Update the item's markType and save
                savedItems[date][index].markType = markType;
                localStorage.setItem('savedItems', JSON.stringify(savedItems));
                return;
            }
        }
    }

    /**
     * Handles a single click on a table row.
     * Sets the clicked row as the 'activeRow' for keyboard shortcuts.
     * @param {HTMLElement} row - The clicked table row element.
     * @param {object} item - The data object for the selected row.
     */
    function handleRowClick(row, item) {
      // Remove mark from any previously active row before marking the new one
      if (activeRow && activeRow !== row) {
        activeRow.classList.remove('marked-row-1', 'marked-row-2');
      }

      // Add the normal mark class to the clicked row
      row.classList.add('marked-row-1');
      // Set the clicked row as the new activeRow for the '1' key
      activeRow = row;

      // Save the mark state to local storage
      saveMarkState(item, 'marked-row-1');

      // Copy customer code to clipboard
      copyToClipboard(item.code);
    }

    /**
     * Handles a right-click on a table row.
     * Prevents the context menu and unmarks the row.
     * @param {Event} e - The right-click event object.
     * @param {HTMLElement} row - The clicked table row element.
     * @param {object} item - The data object for the row.
     */
    function handleRightClick(e, row, item) {
      e.preventDefault();
      // Remove both marking classes on right-click
      row.classList.remove('marked-row-1', 'marked-row-2');
      // If this was the active row, clear the activeRow variable
      if (activeRow === row) {
        activeRow = null;
      }

      // Save the state to local storage to remove the mark
      saveMarkState(item, null);
    }

    /**
     * Handles a double-click on a table row.
     * Copies the formatted string to the clipboard.
     * @param {object} item - The data object for the selected row.
     */
    function handleRowDoubleClick(item) {
      copyToClipboard(item.format);
    }

    // --- New Deletion Functions ---
    /**
     * Removes all data from local storage and refreshes the table.
     */
    function removeAllData() {
      localStorage.removeItem('savedItems');
      renderSavedData({});
      // Optional: also remove invoice data if desired
      localStorage.removeItem('invoiceData');
      customerData = {};
      alert('All saved data has been removed.');
    }

    /**
     * Removes the currently selected data row.
     */
    function removeSelectedData() {
      if (!activeRow) {
        alert('Please select a row to remove by clicking it first.');
        return;
      }

      const savedItems = JSON.parse(localStorage.getItem('savedItems')) || {};
      const dates = Object.keys(savedItems);
      const rowFormat = activeRow.children[2].textContent;

      for (const date of dates) {
        const index = savedItems[date].findIndex(item => item.format === rowFormat);
        if (index !== -1) {
          savedItems[date].splice(index, 1);
          if (savedItems[date].length === 0) {
            delete savedItems[date];
          }
          localStorage.setItem('savedItems', JSON.stringify(savedItems));
          renderSavedData(savedItems);
          activeRow = null; // Clear the active row after deletion
          alert('Selected row has been removed.');
          return;
        }
      }
    }

    /**
     * Removes all data saved on the current day.
     */
    function removeTodayData() {
      const today = new Date().toLocaleDateString();
      const savedItems = JSON.parse(localStorage.getItem('savedItems')) || {};
      
      if (savedItems[today]) {
        delete savedItems[today];
        localStorage.setItem('savedItems', JSON.stringify(savedItems));
        renderSavedData(savedItems);
        alert(`All data for today (${today}) has been removed.`);
      } else {
        alert('No data to remove for today.');
      }
    }
    // --- End of New Deletion Functions ---

    // Event listeners for drag and drop functionality
    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
      document.body.style.background = 'linear-gradient(135deg, #2c253d, #a291b9)';
    });

    document.body.addEventListener('dragleave', (e) => {
      e.preventDefault();
      document.body.style.background = 'linear-gradient(135deg, #1f1c2c, #928dab)';
    });

    document.body.addEventListener('drop', (e) => {
      e.preventDefault();
      document.body.style.background = 'linear-gradient(135deg, #1f1c2c, #928dab)';
      const file = e.dataTransfer.files[0];
      if (file && file.type === "application/pdf") {
        parsePDF(file);
      } else {
        feedbackText.textContent = "Please drop a valid PDF file.";
      }
    });

    /**
     * Parses the dropped PDF file, extracts data, and stores it.
     * It looks for "Customer:" and invoice numbers to build the data object.
     * @param {File} file - The PDF file to be parsed.
     */
    async function parsePDF(file) {
      const fileId = `${file.name}-${file.size}`;
      
      // Check if the file has already been processed to avoid re-parsing
      if (localStorage.getItem(fileId)) {
        feedbackText.textContent = "This PDF has already been processed and saved.";
        return;
      }
      feedbackText.textContent = "Processing PDF... Please wait.";
      const fileReader = new FileReader();
      fileReader.onload = async function() {
        try {
          const typedarray = new Uint8Array(this.result);
          // Set worker source for pdf.js
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
          
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let newCustomerData = {};
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const textItems = textContent.items.map(item => item.str);
            let currentCustomer = null;
            for (let line of textItems) {
              // Extract customer code and name
              if (line.startsWith("Customer:")) {
                let parts = line.replace("Customer:", "").trim().split("-");
                currentCustomer = {
                  code: parts[0].trim(),
                  name: parts.slice(1).join("-").trim()
                };
              } else if (/^\d{4,}/.test(line) && currentCustomer) {
                // Extract invoice number and associate it with the customer
                let invoice = line.split(" ")[0].trim();
                newCustomerData[invoice] = currentCustomer;
              }
            }
          }
          customerData = { ...customerData, ...newCustomerData };
          localStorage.setItem(fileId, 'processed'); // Mark file as processed
          saveToLocalStorage(); // Save the new data to local storage
          feedbackText.textContent = "PDF processed successfully! Data saved. You can now search.";
        } catch (error) {
          feedbackText.textContent = "Error processing PDF. Please try again.";
          console.error("PDF parsing error:", error);
        }
      };
      fileReader.readAsArrayBuffer(file);
    }

    /**
     * Performs a basic invoice search without saving the data.
     * This is the default behavior when the user types and presses Enter.
     */
    function searchInvoice() {
        const input = invoiceInput.value.trim();
        // New, more robust search logic
        let foundInvoice = null;
        for (const key in customerData) {
            // Use a regular expression to check if the input contains the invoice number
            // The \b ensures we match a whole word
            const regex = new RegExp(`\\b${key}\\b`);
            if (regex.test(input) || key === input) {
                foundInvoice = key;
                break;
            }
        }
        
        if (foundInvoice) {
            const { code, name } = customerData[foundInvoice];
            lastInvoiceNumber = foundInvoice; 
            lastCustomerCode = code;
            lastCustomerName = name;
            
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<b>Customer Code:</b> <span class="customer-code">${code}</span><br><b>Customer Name:</b> ${name}<br><b>Invoice Number:</b> ${foundInvoice}`;
            
            // Copy customer code to clipboard
            copyToClipboard(code);
            feedbackText.textContent = `Customer code copied. To save, press 'Z' and enter the receipt number.`;
        } else {
            resultBox.style.display = 'block';
            resultBox.textContent = "Invoice not found! Please try a different number or process a new PDF.";
        }
    }

    /**
     * Handles the full save process, including a receipt number.
     * This function is triggered only after the 'Z' key flow.
     * @param {number} receiptNo - The receipt number entered by the user.
     */
    function saveInvoice(receiptNo) {
      if (!lastInvoiceNumber || !lastCustomerCode || !lastCustomerName) {
          resultBox.textContent = "Please search for an invoice first.";
          return;
      }

      // Automatically update the receipt number based on the last operation
      if (lastOperation === '+') {
        receiptNo++;
      } else if (lastOperation === '-') {
        receiptNo--;
      }
      
      const formattedString = `NVAT ${lastInvoiceNumber} - RECE ${receiptNo}`;
      
      const item = {
          invoice: lastInvoiceNumber,
          code: lastCustomerCode,
          name: lastCustomerName,
          format: formattedString,
          markType: null // New items start with no mark
      };

      const today = new Date().toLocaleDateString();
      let savedItems = JSON.parse(localStorage.getItem('savedItems')) || {};
      
      if (!savedItems[today]) {
        savedItems[today] = [];
      }
      
      const isDuplicate = savedItems[today].some(savedItem => 
        savedItem.invoice === item.invoice && 
        savedItem.format === item.format
      );
      
      if (!isDuplicate) {
        savedItems[today].push(item);
        localStorage.setItem('savedItems', JSON.stringify(savedItems));
        renderSavedData(savedItems);
      }

      znNumber = receiptNo; // Update global znNumber for next automatic entry
      feedbackText.innerHTML = `Formatted string saved. Receipt No updated to ${znNumber}.<br>Current numbering direction: <span id="directionIndicator">${lastOperation === '+' ? 'Increment (+)' : 'Decrement (-)'}</span>`;
      resultBox.style.display = 'none';
      closeModal();
    }
    
    /**
     * Shows the modal to get the operation (+ or -) after the zn number is entered.
     * @param {number} tempZn - The temporary zn number entered by the user.
     */
    function showOpButtons(tempZn) {
      znModalOverlay.style.display = 'flex';
      modalHeading.textContent = "Choose Operation (+/-)";
      znInput.style.display = 'none';
      opButtonsContainer.style.display = 'block';

      function opHandler(e) {
        lastOperation = e.target.id === 'opPlus' ? '+' : '-';
        saveInvoice(parseInt(tempZn));
        opPlusBtn.removeEventListener('click', opHandler);
        opMinusBtn.removeEventListener('click', opHandler);
      }

      opPlusBtn.addEventListener('click', opHandler);
      opMinusBtn.addEventListener('click', opHandler);
    }
    
    /**
     * Closes the 'zn' number modal and resets its state.
     */
    function closeModal() {
      znModalOverlay.style.display = 'none';
      znModalContent.classList.remove('show');
      znInput.value = '';
      znInput.style.display = 'block';
      opButtonsContainer.style.display = 'none';
      modalHeading.textContent = "Enter Receipt No";
    }

    // Master event listener for all keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Toggle visibility on space bar press
      if (e.key === ' ' && document.activeElement !== invoiceInput && document.activeElement !== znInput) {
        e.preventDefault();
        searchContainer.classList.toggle('hidden');
        savedDataContainer.classList.toggle('hidden');
        savedDataContainer.classList.toggle('center-on-screen');
      }

      // Handle 'z' key press to show the premium modal
      if (e.key.toLowerCase() === 'z') {
        e.preventDefault();
        // Check if a search has been performed
        if (lastInvoiceNumber) {
          znModalOverlay.style.display = 'flex';
          setTimeout(() => znModalContent.classList.add('show'), 10);
          znInput.focus();
        } else {
          resultBox.style.display = 'block';
          resultBox.textContent = "Please search for an invoice first to get the details.";
        }
      }
      
      // New logic for keyboard shortcuts
      if (document.activeElement === invoiceInput) {
          if (e.key === '+') {
              lastOperation = '+';
              directionIndicator.textContent = 'Increment (+)';
              feedbackText.innerHTML = `Numbering direction set to: <span style="font-weight: bold; color: yellow;">Increment (+)</span><br>You can now search for the next invoice.`;
          } else if (e.key === '-') {
              lastOperation = '-';
              directionIndicator.textContent = 'Decrement (-)';
              feedbackText.innerHTML = `Numbering direction set to: <span style="font-weight: bold; color: yellow;">Decrement (-)</span><br>You can now search for the next invoice.`;
          }
      }

      // Handle Enter key inside the znInput field
      if (e.key === 'Enter' && znModalOverlay.style.display === 'flex' && znInput.style.display !== 'none') {
        e.preventDefault();
        const enteredZn = znInput.value.trim();
        if (enteredZn && !isNaN(enteredZn)) {
          showOpButtons(parseInt(enteredZn));
        } else {
          closeModal();
        }
      }

      // Handle '1' key for marking the active row with the special color
      if (e.key === '1') {
        // Only proceed if there is an active row
        if (activeRow) {
          // Find the data item associated with the active row
          const item = JSON.parse(localStorage.getItem('savedItems'))[activeRow.parentElement.parentElement.previousElementSibling.textContent.replace('Date: ', '')].find(rowItem => rowItem.format === activeRow.children[2].textContent);
          
          // Remove the normal mark class from the active row
          activeRow.classList.remove('marked-row-1');
          // Add the special mark class to the active row
          activeRow.classList.add('marked-row-2');
          
          // Save the new mark state
          saveMarkState(item, 'marked-row-2');

          // Clear the active row, as the keyboard action is complete
          activeRow = null;
        }
      }
    });

    // Handle 'Enter' key press on the main invoice input field
    invoiceInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        searchInvoice();
      }
    });

    // Function to handle automatic copying to clipboard
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          console.log('Copied to clipboard successfully!');
        }).catch(err => {
          console.error('Failed to copy text: ', err);
          fallbackCopyTextToClipboard(text);
        });
      } else {
        fallbackCopyTextToClipboard(text);
      }
    }

    // Fallback for older browsers
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      // Make the textarea invisible
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          console.log('Fallback copy successful');
        } else {
          console.error('Fallback copy failed');
        }
      } catch (err) {
        console.error('Fallback copy error:', err);
      }
      document.body.removeChild(textArea);
    }
    
    // Initial function call to load data when the page loads
    loadFromLocalStorage();
  </script>
</body>
</html>