<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Extractor | Prabodfx</title>
  <link rel="icon" type="image/png" href="../Projects/fc/inv/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../Projects/fc/inv/favicon.svg" />
  <link rel="shortcut icon" href="../Projects/fc/inv/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../Projects/fc/inv/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Invoice Finder" />
  <link rel="manifest" href="../Projects/fc/inv/site.webmanifest" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    /* --- ROYAL CRYSTAL & PLATINUM THEME --- */
    :root {
        --bg-gradient: linear-gradient(135deg, #1e2024, #232526); /* Deep Charcoal */
        --glass-panel: rgba(255, 255, 255, 0.06); /* Frosted Crystal */
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --accent-gold: #e6c15c;
        --accent-glow: rgba(230, 193, 92, 0.3);
        --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    * {
        box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-gradient);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-primary);
      overflow-y: auto;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

    /* --- Container Architecture --- */
    .container {
      background: var(--glass-panel);
      backdrop-filter: blur(20px); /* Strong blur for premium glass effect */
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 50px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--glass-border);
      position: relative;
    }

    .search-container {
        width: 800px;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        transition: opacity 0.4s ease;
    }

    .saved-container {
        width: 1200px;
        max-width: 95%;
        margin-top: 60px;
        margin-bottom: 60px;
        max-height: 85vh;
        overflow-y: auto;
    }

    /* --- Typography --- */
    h1 {
      font-size: 2.5rem;
      font-weight: 200;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 20px;
      color: var(--text-primary);
      text-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    h2 {
        font-weight: 300;
        color: var(--accent-gold);
        border-bottom: 1px solid var(--glass-border);
        display: inline-block;
        padding-bottom: 15px;
        margin-bottom: 30px;
        letter-spacing: 1px;
    }

    .feedback {
      margin-top: 15px;
      height: 20px;
      font-size: 0.95rem;
      color: var(--accent-gold);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .status-bar {
        margin-top: 15px;
        margin-bottom: 25px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: center;
        gap: 25px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }
    .status-item span {
        color: #fff;
        font-weight: 700;
        border-bottom: 1px solid var(--accent-gold);
    }

    /* --- Inputs (Modern Clean Look) --- */
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 16px 20px;
      margin-bottom: 25px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      color: #fff;
      font-size: 1.15rem;
      text-align: center;
      outline: none;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    input:focus {
      background: rgba(0, 0, 0, 0.5);
      border-color: var(--accent-gold);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    /* --- Buttons (Premium Gradient) --- */
    button {
      padding: 15px 45px;
      border: none;
      border-radius: 50px; /* Pill shape */
      /* Sophisticated Gold/Silver Gradient */
      background: linear-gradient(135deg, #d4af37, #f3e5ab, #d4af37); 
      color: #222;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
      filter: brightness(1.1);
    }

    /* --- Results Area --- */
    .result {
      margin-top: 35px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      display: none;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .customer-name {
        display: block;
        font-size: 2.2rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 10px;
        letter-spacing: -0.5px;
    }
    .customer-code {
        display: block;
        font-size: 1.4rem;
        color: var(--accent-gold);
        font-weight: 400;
        margin-bottom: 15px;
    }
    .invoice-info {
        display: inline-block;
        padding: 8px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 30px;
        font-size: 1.2rem;
        color: #eee;
        font-weight: 600;
    }
    
    .warning { color: #ff6b6b; text-shadow: 0 0 10px rgba(255, 107, 107, 0.3); }

    /* --- Saved Tables --- */
    .saved-table-container {
      background: rgba(0,0,0,0.25);
      border-radius: 16px;
      margin-bottom: 30px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .saved-table-container h3 {
      margin: 0;
      padding: 18px 30px;
      background: rgba(255,255,255,0.05);
      color: #ddd;
      font-size: 1.1rem;
      text-align: left;
      font-weight: 500;
      letter-spacing: 1px;
    }

    .saved-list { list-style: none; padding: 0; margin: 0; }

    /* --- ROW ITEM STYLING --- */
    .saved-item {
        display: flex;
        align-items: center;
        padding: 18px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .saved-item:last-child { border-bottom: none; }
    
    .saved-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    /* Selected State */
    .saved-item.selected {
        background: rgba(255, 255, 255, 0.12); 
        border-left: 4px solid var(--accent-gold);
        padding-left: 26px; /* Adjust for border */
    }
    .saved-item.selected .item-name { color: #fff; font-weight: 700; }
    
    /* Marked Premium State */
    .saved-item.marked-premium {
        background: rgba(255, 50, 50, 0.1);
        border-left: 4px solid #ff4444;
        padding-left: 26px;
    }

    .item-name {
        width: 350px;
        flex-shrink: 0;
        font-size: 1.05rem;
        color: #e0e0e0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
    }

    .item-code {
        width: 200px;
        flex-shrink: 0;
        color: var(--accent-gold);
        font-weight: 600;
        text-align: left;
        font-family: monospace;
        font-size: 1.15rem;
    }

    .item-invoice {
        width: 300px;
        flex-shrink: 0;
        font-style: italic;
        color: #888;
        text-align: left;
        font-size: 0.95rem;
    }

    /* --- DOC BADGE (Premium Gold Tag) --- */
    .doc-badge {
        display: inline-block;
        background: linear-gradient(135deg, #e6c15c, #d4af37);
        color: #111; /* Dark text for contrast */
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 800;
        font-size: 0.8rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: auto;
        border: 1px solid rgba(255,255,255,0.3);
        white-space: nowrap;
    }

    /* --- Dragging --- */
    .saved-item.dragging {
        opacity: 0.6;
        background: #000;
        border: 1px dashed #666;
    }

    /* --- Modals (Dark & Clean) --- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); /* Darker overlay */
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: #1a1a1a;
      padding: 45px;
      border-radius: 20px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.6);
      width: 420px;
      text-align: center;
      border: 1px solid #333;
    }
    
    .modal-content h3 {
        margin-top: 0;
        color: #fff;
        font-weight: 300;
        font-size: 1.6rem;
        margin-bottom: 25px;
        border: none;
    }
    
    /* --- EDIT INVOICE SELECT FIX --- */
    /* Targeting the select specifically to make it bigger */
    #operatorSelect {
        width: 100%;
        padding: 12px;
        height: 55px; /* Increased Height */
        background: #2b2b2b;
        color: #fff;
        border: 1px solid #555;
        border-radius: 10px;
        margin-bottom: 25px;
        font-size: 1.5rem; /* Bigger Font */
        text-align: center;
        text-align-last: center; /* Centers the text in some browsers */
        cursor: pointer;
        appearance: none; /* Removes default styling */
        -webkit-appearance: none;
    }
    
    /* Hover effect for the select */
    #operatorSelect:hover {
        border-color: var(--accent-gold);
        background: #333;
    }

    /* General modal inputs */
    .modal-content input, .modal-content textarea {
        width: 100%;
        background: #2b2b2b;
        border: 1px solid #444;
        color: #fff;
        border-radius: 10px;
        padding: 15px;
    }
    
    .modal-content button {
        width: 45%;
        margin: 10px 5px 0 5px;
        padding: 12px;
        font-size: 0.95rem;
    }

    /* Media query */
    @media (max-width: 800px) {
        .search-container, .saved-container {
            width: 100%;
            padding: 20px;
        }
        .item-name { width: 40%; }
        .item-code { width: 30%; }
        .item-invoice { display: none; } 
    }
  </style>
</head>
<body>

  <div class="saved-container container" id="savedSection">
      <h2>Saved Invoices</h2>
      <div id="savedTablesContainer"></div>
  </div>

  <div class="search-container container" id="searchSection">
    <h1>Invoice Data Extractor</h1>
    <p class="feedback" id="feedback-text"></p>
    <div class="status-bar" id="statusBar"></div>
    <input type="text" id="invoiceInput" placeholder="Enter Invoice Number" autofocus>
    <br>
    <button onclick="searchInvoice()">Search</button>
    <div class="result" id="resultBox"></div>
  </div>
  
  <div id="receiptModal" class="modal-overlay">
      <div class="modal-content">
          <h3>Edit Invoice No Format</h3>
          <input type="text" id="receiptNoInput" placeholder="Receipt No" autocomplete="off" style="margin-bottom: 15px;">
          <select id="operatorSelect">
              <option value="+">+</option>
              <option value="-">-</option>
          </select>
          <button onclick="submitReceiptInfo()">Submit</button>
          <button onclick="closeModal()">Cancel</button>
      </div>
  </div>

  <div id="editModal" class="modal-overlay">
      <div class="modal-content">
          <h3>Edit Full Invoice Content</h3>
          <textarea id="editContentInput" placeholder="Enter new invoice content"></textarea>
          <button onclick="submitEditContent()">Save</button>
          <button onclick="closeEditModal()">Cancel</button>
      </div>
  </div>
  
  <div id="docModal" class="modal-overlay">
      <div class="modal-content">
          <h3>Enter DOC No</h3>
          <input type="number" id="docNoInput" placeholder="Enter Start Number" autocomplete="off">
          <button onclick="submitDocNo()">Set DOC</button>
          <button onclick="closeDocModal()">Cancel</button>
      </div>
  </div>

  <div id="countModal" class="modal-overlay">
      <div class="modal-content">
          <h3>Inv No Count Lock</h3>
          <p style="font-size: 0.9rem; margin-bottom: 15px; color: #aaa;">How many invoices to keep current receipt #?</p>
          <input type="number" id="countInput" placeholder="Enter Count (e.g. 5)" autocomplete="off">
          <button onclick="submitLockCount()">Lock</button>
          <button onclick="closeCountModal()">Cancel</button>
      </div>
  </div>

  <script>
    // --- Global State ---
    let customerData = {};
    let savedData = {};
    let selectedItems = [];
    let markedItems = [];
    let activeRow = null;
    
    // Drag/Drop State
    let draggedItem = null;

    // Process State
    let processingActive = false;
    let currentReceiptNo = null;
    let receiptOperator = null;
    let rightClickedInvoice = null;

    // Feature State
    let currentDocNo = null;
    let receiptLockCount = 0;

    // --- DOM Elements ---
    const feedbackText = document.getElementById('feedback-text');
    const statusBar = document.getElementById('statusBar');
    const invoiceInput = document.getElementById('invoiceInput');
    const resultBox = document.getElementById('resultBox');
    const searchSection = document.getElementById('searchSection');
    const savedSection = document.getElementById('savedSection');
    const savedTablesContainer = document.getElementById('savedTablesContainer');
    
    // Modals
    const receiptModal = document.getElementById('receiptModal');
    const receiptNoInput = document.getElementById('receiptNoInput');
    const operatorSelect = document.getElementById('operatorSelect');
    const editModal = document.getElementById('editModal');
    const editContentInput = document.getElementById('editContentInput');
    const docModal = document.getElementById('docModal');
    const docNoInput = document.getElementById('docNoInput');
    const countModal = document.getElementById('countModal');
    const countInput = document.getElementById('countInput');

    /**
     * Date Helper
     */
    function getCurrentDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart('2', '0');
        const day = String(today.getDate()).padStart('2', '0');
        return `${year}-${month}-${day}`;
    }
    
    /**
     * Update Status Bar
     */
    function updateStatusBar() {
        let statusHtml = '';
        if (currentDocNo !== null) {
            statusHtml += `<div class="status-item">DOC No: <span>${currentDocNo}</span></div>`;
        }
        if (processingActive && receiptLockCount > 0) {
            statusHtml += `<div class="status-item">Receipt Lock: <span>${receiptLockCount} left</span></div>`;
        }
        statusBar.innerHTML = statusHtml;
    }

    /**
     * Load Data from LocalStorage
     */
    function loadFromLocalStorage() {
      const storedData = localStorage.getItem('invoiceData');
      if (storedData) {
        customerData = JSON.parse(storedData);
        feedbackText.textContent = `Data loaded from previous sessions.`;
      }
      loadSelectedItems();
      loadMarkedItems();
      loadSavedFromLocalStorage();
      savedSection.style.display = 'none';
      searchSection.style.display = 'block';
      updateStatusBar();
    }

    function loadSavedFromLocalStorage() {
      const storedSavedData = localStorage.getItem('savedInvoices');
      if (storedSavedData) {
        savedData = JSON.parse(storedSavedData);
      }
      renderSavedTables();
    }
    
    function loadSelectedItems() {
        const storedSelected = localStorage.getItem('selectedInvoices');
        if (storedSelected) {
            selectedItems = JSON.parse(storedSelected);
        }
    }
    
    function loadMarkedItems() {
        const storedMarked = localStorage.getItem('markedInvoices');
        if (storedMarked) {
            markedItems = JSON.parse(storedMarked);
        }
    }

    function saveToLocalStorage() {
      localStorage.setItem('invoiceData', JSON.stringify(customerData));
    }
    
    function saveSavedToLocalStorage() {
      localStorage.setItem('savedInvoices', JSON.stringify(savedData));
    }
    
    function saveSelectedItems() {
        localStorage.setItem('selectedInvoices', JSON.stringify(selectedItems));
    }
    
    function saveMarkedItems() {
        localStorage.setItem('markedInvoices', JSON.stringify(markedItems));
    }

    // --- Drag and Drop (PDF) ---
    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
      document.body.style.background = '#1e1e1e';
    });

    document.body.addEventListener('dragleave', (e) => {
      e.preventDefault();
      document.body.style.background = 'linear-gradient(135deg, #1e2024, #232526)';
    });

    document.body.addEventListener('drop', (e) => {
      e.preventDefault();
      document.body.style.background = 'linear-gradient(135deg, #1e2024, #232526)';
      const file = e.dataTransfer.files[0];
      if (file && file.type === "application/pdf") {
        parsePDF(file);
      } else {
        feedbackText.textContent = "Please drop a valid PDF file.";
      }
    });

    /**
     * Parse PDF
     */
    async function parsePDF(file) {
      const fileId = `${file.name}-${file.size}`;
      
      if (localStorage.getItem(fileId)) {
        feedbackText.textContent = "This PDF has already been processed and saved.";
        return;
      }
      feedbackText.textContent = "Processing PDF... Please wait.";
      
      const fileReader = new FileReader();
      fileReader.onload = async function() {
        try {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
          
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let newCustomerData = {};
          let lastCustomer = null;
          
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const textItems = textContent.items.map(item => item.str);
            
            for (let line of textItems) {
              if (line.startsWith("Customer:")) {
                let parts = line.replace("Customer:", "").trim().split("-");
                lastCustomer = {
                  code: parts[0].trim(),
                  name: parts.slice(1).join("-").trim()
                };
              } else if (/^\d{3,6}$/.test(line.trim())) {
                if (lastCustomer) {
                  newCustomerData[line.trim()] = lastCustomer;
                }
              }
            }
          }

          customerData = { ...customerData, ...newCustomerData };
          localStorage.setItem(fileId, 'processed');
          saveToLocalStorage();
          feedbackText.textContent = "PDF processed successfully! Data saved. You can now search.";
        } catch (error) {
          feedbackText.textContent = "Error processing PDF. Please try again.";
          console.error("PDF parsing error:", error);
        }
      };
      fileReader.readAsArrayBuffer(file);
    }

    /**
     * Clipboard Fallback for Firefox/Local Files
     */
    async function copyTextToClipboard(text) {
        if (!navigator.clipboard) {
            fallbackCopyTextToClipboard(text);
            return;
        }
        try {
            await navigator.clipboard.writeText(text);
            feedbackText.textContent = "Copied to clipboard!";
        } catch (err) {
            console.error('Async: Could not copy text: ', err);
            fallbackCopyTextToClipboard(text);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                feedbackText.textContent = "Copied to clipboard!";
            } else {
                feedbackText.textContent = "Copy failed. Please copy manually.";
            }
        } catch (err) {
            feedbackText.textContent = "Copy failed. Please copy manually.";
        }
        document.body.removeChild(textArea);
    }

    /**
     * Search Invoice
     */
    async function searchInvoice() {
        const userInput = invoiceInput.value.trim();
        const searchKey = userInput.split(/[-()]/)[0].trim();
        
        let foundInvoice = null;
        for (const key in customerData) {
            if (key === searchKey) {
                foundInvoice = key;
                break;
            }
        }
        
        if (foundInvoice) {
            const { code, name } = customerData[foundInvoice];
            resultBox.style.display = 'block';
            resultBox.classList.remove('warning');
            resultBox.innerHTML = `
              <div class="result-item customer-name">${name}</div>
              <div class="result-item customer-code">${code}</div>
              <div class="result-item invoice-info">Invoice No: ${foundInvoice}</div>
            `;
            addInvoiceToSavedList(userInput, customerData[foundInvoice], foundInvoice);
            copyTextToClipboard(code);
        } else {
            resultBox.style.display = 'block';
            resultBox.textContent = "Invoice not found ⚠️";
            resultBox.classList.add('warning');
            feedbackText.textContent = "";
        }
        
        if (userInput.includes('-') && !processingActive) {
            const parts = userInput.split('-');
            const potentialReceiptNo = parseInt(parts[1]);
            if (!isNaN(potentialReceiptNo)) {
                processingActive = true;
                currentReceiptNo = potentialReceiptNo;
                receiptOperator = '+';
                toggleSections();
                feedbackText.textContent = `Auto-increment started. Next receipt will be ${currentReceiptNo + 1}. Press 'z' to end.`;
            }
        }
        updateStatusBar();
    }
    
    /**
     * Add to Saved List
     */
    function addInvoiceToSavedList(userInput, customer, foundInvoice) {
        const today = getCurrentDate();
        if (!savedData[today]) {
            savedData[today] = {};
        }

        let finalSavedKey = foundInvoice;
        let invoiceDocNo = null;

        if (processingActive) {
            if (receiptLockCount > 0) { } else {
                 if (receiptOperator === '+') currentReceiptNo++;
                 else if (receiptOperator === '-') currentReceiptNo--;
            }
            finalSavedKey = `NVAT ${userInput} - Rece ${currentReceiptNo}`;
        }

        if (currentDocNo !== null) {
            invoiceDocNo = currentDocNo;
        }

        if (!savedData[today][finalSavedKey]) {
            savedData[today][finalSavedKey] = { 
                ...customer, 
                originalInvoice: foundInvoice, 
                savedUserInput: userInput,
                docNo: invoiceDocNo
            };
            saveSavedToLocalStorage();
            renderSavedTables();
        }

        if (processingActive && receiptLockCount > 0) {
            receiptLockCount--;
        }
        if (currentDocNo !== null) {
            currentDocNo++;
        }
        updateStatusBar();
    }

    /**
     * Render Saved Tables
     */
    function renderSavedTables() {
      savedTablesContainer.innerHTML = '';
      const dates = Object.keys(savedData).sort().reverse();
      dates.forEach(date => {
        const tableContainer = document.createElement('div');
        tableContainer.className = 'saved-table-container';
        tableContainer.innerHTML = `<h3>${date}</h3>
          <ul class="saved-list"></ul>
        `;
        const savedList = tableContainer.querySelector('.saved-list');
        const invoices = Object.keys(savedData[date]).reverse();
        
        invoices.forEach(invoiceNo => {
          const entry = savedData[date][invoiceNo];
          const { code, name, originalInvoice, savedUserInput, docNo } = entry;
          
          const listItem = document.createElement('li');
          listItem.className = 'saved-item';
          listItem.setAttribute('draggable', true);

          let docBadgeHtml = '';
          if (docNo !== undefined && docNo !== null) {
              docBadgeHtml = `<span class="doc-badge">DOC ${docNo}</span>`;
          }

          listItem.innerHTML = `
            <div class="item-name">${name}</div>
            <div class="item-code">${code}</div>
            <div class="item-invoice">${invoiceNo}</div>
            ${docBadgeHtml}
          `;
          
          listItem.dataset.code = code;
          listItem.dataset.originalInvoice = originalInvoice || invoiceNo;
          listItem.dataset.invoiceNo = invoiceNo; 
          listItem.dataset.savedUserInput = savedUserInput;
          
          if (selectedItems.includes(invoiceNo)) {
              listItem.classList.add('selected');
          }
          if (markedItems.includes(invoiceNo)) {
              listItem.classList.add('marked-premium');
          }
          
          listItem.addEventListener('click', (e) => copyCodeAndMarkRow(e));
          listItem.addEventListener('mousedown', (e) => {
              if (e.button === 0) activeRow = listItem;
          });
          listItem.addEventListener('dblclick', (e) => {
              if (processingActive) {
                  feedbackText.textContent = "A process is already active. Press 'z' to end it first.";
              } else {
                  rightClickedInvoice = listItem.dataset.originalInvoice;
                  openModal();
              }
          });
          listItem.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              copyInvoiceNoFromRow(e);
          });
          
          listItem.addEventListener('dragstart', handleDragStart);
          listItem.addEventListener('dragover', handleDragOver);
          listItem.addEventListener('drop', handleDrop);
          listItem.addEventListener('dragend', handleDragEnd);

          savedList.appendChild(listItem);
        });
        savedTablesContainer.appendChild(tableContainer);
      });
    }

    // --- Drag and Drop Handlers ---
    function handleDragStart(e) {
      draggedItem = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('.saved-item');
        if (target && target !== draggedItem) {
            const savedList = target.parentElement;
            const bounding = target.getBoundingClientRect();
            const offset = bounding.y + (bounding.height / 2);

            if (e.clientY < offset) {
                if (draggedItem !== target.previousElementSibling) {
                    savedList.insertBefore(draggedItem, target);
                }
            } else {
                if (draggedItem !== target.nextElementSibling) {
                    savedList.insertBefore(draggedItem, target.nextSibling);
                }
            }
        }
    }
    
    function handleDrop(e) {
      e.preventDefault();
      updateSavedDataOrder();
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      draggedItem = null;
    }

    function updateSavedDataOrder() {
        const savedLists = document.querySelectorAll('.saved-list');
        savedLists.forEach(savedList => {
            const date = savedList.closest('.saved-table-container').querySelector('h3').textContent;
            const newOrder = Array.from(savedList.children).map(li => li.dataset.invoiceNo);
            const reorderedData = {};
            newOrder.forEach(invoiceNo => {
                if (savedData[date][invoiceNo]) {
                    reorderedData[invoiceNo] = savedData[date][invoiceNo];
                }
            });
            savedData[date] = reorderedData;
        });
        saveSavedToLocalStorage();
    }

    // --- Modal Functions ---
    function openModal() {
        receiptModal.style.display = 'flex';
        receiptNoInput.focus();
    }
    function closeModal() {
        receiptModal.style.display = 'none';
        receiptNoInput.value = '';
    }
    function submitReceiptInfo() {
        const receiptNo = receiptNoInput.value.trim();
        const operator = operatorSelect.value;
        if (!receiptNo || isNaN(parseInt(receiptNo, 10))) {
            alert("Please enter a valid receipt number.");
            return;
        }
        handleRightClick(rightClickedInvoice, receiptNo, operator);
        closeModal();
    }
    function openEditModal() {
        if (!activeRow) {
            feedbackText.textContent = "Please select a row to edit first.";
            return;
        }
        const invoiceNo = activeRow.dataset.invoiceNo;
        editContentInput.value = invoiceNo;
        editModal.style.display = 'flex';
        editContentInput.focus();
    }
    function closeEditModal() {
        editModal.style.display = 'none';
        editContentInput.value = '';
    }
    function submitEditContent() {
        const newContent = editContentInput.value.trim();
        if (!newContent) {
            alert("Content cannot be empty.");
            return;
        }
        const oldInvoiceNo = activeRow.dataset.invoiceNo;
        const date = getCurrentDate();
        if (savedData[date] && savedData[date][oldInvoiceNo]) {
            let newInvoiceNo = newContent;
            let updatedEntry = { ...savedData[date][oldInvoiceNo] };
            const newInvoiceNumberOnly = newContent.split(/[-()]/)[0].trim();
            const newCustomer = customerData[newInvoiceNumberOnly];
            if (newCustomer) {
                updatedEntry.name = newCustomer.name;
                updatedEntry.code = newCustomer.code;
            }
            const wasMarked = markedItems.includes(oldInvoiceNo);
            if (wasMarked) {
                const index = markedItems.indexOf(oldInvoiceNo);
                if (index > -1) markedItems.splice(index, 1);
                markedItems.push(newInvoiceNo);
                saveMarkedItems();
            }
            delete savedData[date][oldInvoiceNo];
            savedData[date][newInvoiceNo] = updatedEntry;
            saveSavedToLocalStorage();
            renderSavedTables();
            feedbackText.textContent = `Invoice content updated.`;
        }
        closeEditModal();
        activeRow = null;
    }
    
    function handleRightClick(originalInvoice, receiptInput, operator) {
        processingActive = true;
        currentReceiptNo = parseInt(receiptInput, 10);
        receiptOperator = operator;
        const today = getCurrentDate();
        let oldInvoiceKey = null;
        let savedUserInput = null;
        let docNoToPreserve = null;
        for (const key in savedData[today]) {
            if (savedData[today][key].originalInvoice === originalInvoice) {
                oldInvoiceKey = key;
                savedUserInput = savedData[today][key].savedUserInput;
                docNoToPreserve = savedData[today][key].docNo;
                break;
            }
        }
        if (oldInvoiceKey) {
            const { code, name } = savedData[today][oldInvoiceKey];
            let newInvoiceKey = `NVAT ${savedUserInput} - Rece ${receiptInput}`;
            const wasMarked = markedItems.includes(oldInvoiceKey);
            if (wasMarked) {
              const index = markedItems.indexOf(oldInvoiceKey);
              if (index > -1) markedItems.splice(index, 1);
              if (!markedItems.includes(newInvoiceKey)) markedItems.push(newInvoiceKey);
              saveMarkedItems();
            }
            delete savedData[today][oldInvoiceKey];
            savedData[today][newInvoiceKey] = { 
                code, name, originalInvoice, savedUserInput,
                docNo: docNoToPreserve
            };
            saveSavedToLocalStorage();
            renderSavedTables();
        }
        if (savedSection.style.display !== 'none') {
            feedbackText.textContent = `Processing started. Press 'z' to end.`;
        }
        updateStatusBar();
    }

    function toggleSections() {
      if (searchSection.style.display !== 'none') {
        searchSection.style.display = 'none';
        savedSection.style.display = 'block';
        feedbackText.textContent = ""; 
      } else {
        searchSection.style.display = 'block';
        savedSection.style.display = 'none';
        invoiceInput.value = '';
        invoiceInput.focus();
        feedbackText.textContent = ""; 
        resultBox.style.display = 'none';
        updateStatusBar();
      }
    }

    async function copyCodeAndMarkRow(event) {
      if (draggedItem) return;
      const item = event.currentTarget;
      const code = item.dataset.code;
      const invoiceNo = item.dataset.invoiceNo;
      item.classList.toggle('selected');
      if (item.classList.contains('selected')) {
          if (!selectedItems.includes(invoiceNo)) selectedItems.push(invoiceNo);
      } else {
          selectedItems = selectedItems.filter(item => item !== invoiceNo);
      }
      saveSelectedItems();
      copyTextToClipboard(code);
    }

    async function copyInvoiceNoFromRow(event) {
      event.preventDefault();
      const item = event.currentTarget;
      const invoiceNo = item.dataset.invoiceNo;
      copyTextToClipboard(invoiceNo);
    }
    
    function clearAllData() {
        if(confirm("Are you sure you want to delete ALL data? This cannot be undone.")) {
            localStorage.clear();
            customerData = {};
            savedData = {};
            selectedItems = [];
            markedItems = [];
            activeRow = null;
            processingActive = false;
            currentReceiptNo = null;
            receiptOperator = null;
            rightClickedInvoice = null;
            currentDocNo = null;
            receiptLockCount = 0;
            renderSavedTables();
            updateStatusBar();
            feedbackText.textContent = "All data has been cleared.";
        }
    }

    // --- Feature Modals ---
    function openDocModal() {
        docModal.style.display = 'flex';
        docNoInput.focus();
    }
    function closeDocModal() {
        docModal.style.display = 'none';
        docNoInput.value = '';
    }
    function submitDocNo() {
        const val = parseInt(docNoInput.value);
        if (!isNaN(val)) {
            currentDocNo = val;
            feedbackText.textContent = `DOC No set to ${val}. It will auto-increment.`;
        }
        updateStatusBar();
        closeDocModal();
    }

    function openCountModal() {
        countModal.style.display = 'flex';
        countInput.focus();
    }
    function closeCountModal() {
        countModal.style.display = 'none';
        countInput.value = '';
    }
    function submitLockCount() {
        const val = parseInt(countInput.value);
        if (!isNaN(val) && val > 0) {
            receiptLockCount = val;
            feedbackText.textContent = `Receipt No locked for next ${val} entries.`;
        }
        updateStatusBar();
        closeCountModal();
    }

    // --- Event Listeners ---
    searchSection.addEventListener('dblclick', (e) => {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
             openCountModal();
        }
    });

    document.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
      if (e.ctrlKey && key === 'd') {
          e.preventDefault();
          savedData = {};
          selectedItems = [];
          markedItems = [];
          saveSavedToLocalStorage();
          saveSelectedItems();
          saveMarkedItems();
          renderSavedTables();
          feedbackText.textContent = "Saved section data cleared.";
      } else if (key === 's') {
          window.open('https://prabodfx.github.io/web/nav/sh.html', '_blank');
      } else if (key === ' ') {
        e.preventDefault();
        toggleSections();
      } else if (key === 'z' && processingActive) {
        processingActive = false;
        currentReceiptNo = null;
        receiptOperator = null;
        receiptLockCount = 0;
        updateStatusBar();
        feedbackText.textContent = "Processing ended.";
      } else if (e.shiftKey && e.key === 'Delete') {
          e.preventDefault();
          clearAllData();
      } else if (key === 'q') {
          e.preventDefault();
          openDocModal();
      } else if (!isInput && key === 'd' && activeRow) {
          e.preventDefault();
          const invoiceNo = activeRow.dataset.invoiceNo;
          const date = getCurrentDate();
          if (savedData[date] && savedData[date][invoiceNo]) {
              delete savedData[date][invoiceNo];
              saveSavedToLocalStorage();
              const index = markedItems.indexOf(invoiceNo);
              if (index > -1) {
                  markedItems.splice(index, 1);
                  saveMarkedItems();
              }
              renderSavedTables();
              if (processingActive) {
                const deletedReceiptNoMatch = invoiceNo.match(/Rece (\d+)/);
                if (deletedReceiptNoMatch && parseInt(deletedReceiptNoMatch[1]) === currentReceiptNo) {
                  currentReceiptNo--;
                }
              }
          }
          activeRow = null;
      } else if (!isInput && key === 'e' && activeRow) {
          e.preventDefault();
          openEditModal();
      } else if (!isInput && key === 'p' && activeRow) {
          e.preventDefault();
          const invoiceNo = activeRow.dataset.invoiceNo;
          const index = markedItems.indexOf(invoiceNo);
          if (index > -1) markedItems.splice(index, 1);
          else markedItems.push(invoiceNo);
          saveMarkedItems();
          activeRow.classList.toggle('marked-premium');
      } else if (!isInput && key === '+' && activeRow) {
          e.preventDefault();
          const invoiceNo = activeRow.dataset.invoiceNo;
          const receiptNoMatch = invoiceNo.match(/Rece (\d+)$/);
          if (receiptNoMatch) {
              processingActive = true;
              currentReceiptNo = parseInt(receiptNoMatch[1], 10);
              receiptOperator = '+';
              updateStatusBar();
          }
      } else if (!isInput && key === '-' && activeRow) {
        e.preventDefault();
        const invoiceNo = activeRow.dataset.invoiceNo;
        const receiptNoMatch = invoiceNo.match(/Rece (\d+)$/);
        if (receiptNoMatch) {
            processingActive = true;
            currentReceiptNo = parseInt(receiptNoMatch[1], 10);
            receiptOperator = '-';
            updateStatusBar();
        }
      }
    });

    invoiceInput.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        invoiceInput.value = '';
    });
    invoiceInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchInvoice();
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.saved-item')) activeRow = null;
    });
    editContentInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitEditContent();
      }
    });
    receiptNoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            operatorSelect.value = '+';
            submitReceiptInfo();
        } else if (e.key === '-') {
            e.preventDefault();
            operatorSelect.value = '-';
            submitReceiptInfo();
        }
    });
    docNoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitDocNo();
        }
    });
    countInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitLockCount();
        }
    });

    loadFromLocalStorage();
  </script>
</body>
</html>
