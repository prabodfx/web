<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../Projects/fc/paster/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../Projects/fc/paster/favicon.svg" />
  <link rel="shortcut icon" href="../Projects/fc/paster/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../Projects/fc/paster/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Paster" />
  <link rel="manifest" href="../Projects/fc/paster/site.webmanifest" />
  <title>Auto Paste | Prabodfx</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
    .modal { background-color: rgba(0,0,0,.5); }
    .modal-content { background:#fff; }
    .search-bar { transition: all 0.3s ease-in-out; }
    .code-card:hover {
        background-color: #e5e7eb;
    }
    .flash-red {
        animation: flash-red-animation 0.5s ease-in-out;
    }
    @keyframes flash-red-animation {
        0% { background-color: #e5e7eb; }
        50% { background-color: #ef4444; }
        100% { background-color: #e5e7eb; }
    }
    /* This class permanently marks the card in red */
    .marked-red {
        background-color: #ef4444 !important; /* Tailwind's red-500 */
        color: white !important;
    }
    .marked-red span {
        color: white !important;
    }
  </style>
</head>

<body class="p-8" oncontextmenu="return false;">

  <div class="max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">Customer Code Paster</h1>
    <p class="text-gray-600 mb-6 text-center">
      Reciept Can be Easily Setoff Now ðŸ“Œ
    </p>

    <div class="flex flex-col sm:flex-row gap-4 mb-6 relative">
      <input id="search-bar" type="text" placeholder="Enter code here..." class="w-full px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md search-bar hidden">
    </div>
    
    <div id="message-box" class="text-center p-3 rounded-lg font-semibold text-white mb-6 hidden"></div>

    <div id="codes-container" class="space-y-6">
        </div>
  </div>

  <div id="duplicate-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
    <div class="modal-content p-6 rounded-lg shadow-xl text-center max-w-sm">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Duplicate Entry Detected</h2>
      <p class="mb-6 text-gray-600">This item is already added. Add it again?</p>
      <div class="flex justify-center gap-4">
        <button id="modal-yes" class="px-6 py-2 rounded-full text-white bg-blue-600 hover:bg-blue-700 shadow-md font-semibold">Yes</button>
        <button id="modal-no" class="px-6 py-2 rounded-full text-gray-800 bg-gray-200 hover:bg-gray-300 shadow-md font-semibold">No</button>
      </div>
    </div>
  </div>

  <div id="remove-mark-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
    <div class="modal-content p-6 rounded-lg shadow-xl text-center max-w-sm">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Remove Mark?</h2>
      <p class="mb-6 text-gray-600">Do you want to remove the red mark from this item?</p>
      <div class="flex justify-center gap-4">
        <button id="remove-yes" class="px-6 py-2 rounded-full text-white bg-red-600 hover:bg-red-700 shadow-md font-semibold">Yes</button>
        <button id="remove-no" class="px-6 py-2 rounded-full text-gray-800 bg-gray-200 hover:bg-gray-300 shadow-md font-semibold">No</button>
      </div>
    </div>
  </div>

  <script>
    // --- Data mapping and elements ---
    const embilipitiyaData = {
        "AP001":"NALAKA FINACE SOLUTION","BK002":"V.P H/W","BRW001":"RATHNAYAKA H/W","BRW025":"Abegunawardhana H/w","BULU001":"SETHUN HARDWERE","BVB001":"BALAVINNA H/W","BVB002":"GOLD STEEL","BVB003":"JAYASIRI HARDWARE","CASH":"CASH CUSTOMER","EMB025":"M.J.H/W","EMB088":"Royal Cake","EMB089":"ANUHAS H/W","EMB55":"NM HARDWARE","EME002":"INOSHA H/W","EME003":"MATARA H/W","EME006":"UDAGAMA H/W","EME012":"MAHINDA CONSTRUCTION","EME023":"TRADRE CENTER SUMANAGIRI","EME024":"SUMITH H/W","EME025":"WICKRAMA HARWARE STORES (PVT)","EME027":"EMBILIPITIYA STORES (PVT) LTD","EME029":"UDARA TRADRE CENTER", "EME032":"SARATHCHANDRA HOME CENTER", "EME035":"PRIYANTHA H/W", "EME046":"CENTRAL H/W", "EME056":"NALIN HARDWARE & TOOLS CENTER", "EME057":"RENDILA PLASTICS", "EME059":"SANDARU ENTERPRISES", "EME076":"SIRIKATHA H/W", "EME077":"N S D.H/W", "PNP001":"PANAMURA H/W", "PNP003":"DHANUSHKA H/W", "PNP010":"ATHULA H/W", "PNP011":"D.E.P HARDWARE", "PNP014":"SINGHA ENTERPRISES", "PNP016":"LIYANAGE STORES", "PNP017":"ISURU H/W", "PNP025":"LAKMAL H/W", "PNP025":"THILAK H/W", "PNP026":"GANESH H/W", "POT001":"SUGATH H/W", "PTP002":"HAPUARACHCHI TRADRE CENTER", "GWG007":"GALAHITIYA AGRO", "GWG012":"SANKO CONCRETE WORKS & HARDWARE", "GWG013":"CHELO FACTORY", "GWG029":"WEERASINGHA H/W", "GWG030":"T.R.M H/W", "GWG031":"KUMBURUGAMUWA STORES", "HAM002":"THISSA H/W", "HAM001":"ASHANKA ELECTRICLE", "KA001":"THATHSARANI H/W", "KP001":"SEWMI HARDWARE", "KP058":"ANANDA F/H", "KP059":"NIMAL CEREMIC AND GIFT CENTER", "KUA004":"DHANAPALA HARDWARE", "MDP001":"K.A. H/W", "MK002":"WASANTHA HARDWARE", "ML001":"SHAN H/W", "SW012":"SAVIJA HARDWARE", "SW016":"RANGA HARDWARE", "SW018":"INDIKA HARDWARE", "SW020":"V.G.L H/W", "SW025":"NEW P&C H/W", "SW027":"HARSHA H/W", "SW028":"W.G H/W", "SW030":"PRASANNA H/W", "SW045":"SINGHE HARDWARE", "SW047":"OLITHA H/W", "SW100":"JAYAWEERA H/W", "SW075":"NIRMANA HARDWARE", "SW077":"WASANA HARDWARE", "SW094":"SENEVIRATHNE HARDWARE", "KL005":"KAPILA STORES", "KL006":"D.D STORES", "KL007":"D.G ELECTRICAL", "KL008":"LANKA TRADING", "KL013":"S.L.N SENANAYAKA", "KL014":"BUDDHIKA HARDWARE", "KL015":"NEW KAPILA STORES & HARDWARE", "KL019":"DHANARANJANA H/W", "KL029":"MAKULUTHOTA", "KMB005":"SRI JAYA ENTERPRICES", "KOG001":"DALUMURAGAMA HARDWARE", "UW004":"PATHIRANA H/W", "UW005":"PATHMAPERUMA H/W", "UW009":"JAYAKODI H/W", "UW010":"GODAGEWATHTHA H/W", "UW011":"VINOTH STEEL", "RWR011":"JAYANTHA HARDWARE", "SE001":"NEW PATHIRANA H/W", "SE005":"THENUDI HARDWARE", "SE008":"RUWAN H/W", "SG001":"SHASHIMALL HARDWARE", "SG004":"LESINDU H/W", "SLS002":"LAKSHITHA H/W", "SLS003":"LIYANAGE H/W", "PD300":"VINITH ENTERPRISES", "PDN003":"PADALANGALA H/W", "PG001":"WEERATHUNGA H/W", "PNM032":"SANDAMALI H/W", "RW001":"RAKWANA HARDWARE", "RW005":"D.A.G HARDWARE", "WL001":"GAMAGE H/W", "WO001":"HARSHA MOTORS", "WO004":"LAKJAYA STORES", "WO005":"NALINDA H/W", "WO006":"NEW SENARATH H/W", "WO008":"THEJAN H/W", "WO011":"GUNASEKARA H/W", "WO012":"JAYAMINI STORES", "WO013":"MADUSHANKA H/W", "WO014":"BIMANSA STORES", "WO015":"SEPALI H/W", "WO016":"SATHIRA CONSTRUCTION",
    };

    const katuwanaData = {
        "AKA003":"GAMAGE STORES", "AKA004":"SOMASIRI STORES", "AKA008":"DASA HW", "AKA012":"MADURANGA H/W", "AKA024":"M.K.STORES", "AKA025":"WEERASINGHE STORES - BINKAMA", "AKA036":"INDIKA H/W - USWEWA", "AKA037":"Jinasena H/w", "AKA038":"RUMESH HARDWARE", "AKA041":"SIRIWARDENA HARDWARE", "AKA044":"WICKRAMASEKARA GLASS CENTRE", "AKA045":"GANINDU HARDWARE", "AKA046":"RATHNAYAKE STORES - DANDENIGAMA", "AKA053":"SOHOYURO H/W", "AKA100":"RANJEEWA HARDWARE", "AKA101":"WIJESINGHE HARDWARE", "AKA102":"R.G.S HARDWARE", "aka127":"D.G.Super h/w", "AKA200":"SURANGA ENTERPRISES", "aka502":"RUBASINHE GENARAL STEEL & H/W", "AKA75":"Indika H/w", "ATA013":"AMARASINGHE BROTHERS", "ATA018":"ARUNA HW", "ATA021":"SRIYANI FH", "ATA027":"WEERASINGHE HW", "ATA033":"HEWARATHANA  H/W", "ATA042":"V.P. H/W", "ATA043":"DILSTAR HARDWARE", "ATA049":"SANUJI ENTERPRICES", "ATA062":"P.L.HARDWARE", "ATA064":"SANDUN HARDWARE", "ATA078":"SHAN ENTERPRICES", "ATA080":"WIJESEKARA HARDWARE", "ata085":"SITHARA TELERS", "ATA092":"T S MART", "ATA114":"NIMAL STORES", "ATA121":"RUWAN HARDWARE", "ATA129":"PEHESARA ENTERPRISES", "ATA203":"KUMA HARDWARE", "ATA23":"SHANTHA HW", "ATA399":"ONEL H/W", "ATA51":"Weerawarna h/w", "ATA70":"ROSHAN HW", "ATA77":"LIMO H/W", "BAA003":"LANKA HW", "BAA011":"LAKMINI HW", "BAA017":"DHARSANA PAINT", "BAA018":"JAYA STORES", "BAA019":"SINGHE H/W", "BAA034":"KODITHUWAKKU HARDWARE", "BAA036":"THILAK H/W", "BAA039":"OSHADI GLASS CENTRE", "BAA040":"RATHNAYAKE GIFT HOUSE", "BAA053":"BUDDHIKA HARDWARE", "BAA055":"MINUDI ENTERPRISES", "BAA062":"RASHAN HW", "BAA063":"TISSAKUTTIARACHCHI HW", "BAA064":"S.D.HARDWARE", "BAA066":"WANNIARACHCHI H/W", "BAA111":"AMILA H/W - BELIGALLA", "BAA112":"N.S.P.H/W", "BAA150":"SAMANTHA H/W", "baa206":"SANDALI HW & TRANSPORT", "BAA234":"SITHUMINI HW", "BAA256":"C.S. H/W", "baa378":"BELIATTA H/W", "BAA399":"S.N.P. H/W", "BAA456":"WIJAYANGA H/W", "baa555":"K.S.R HW", "BAA72":"Shan H/W", "BAA789":"CHANDRIKA PICTUER PALACE", "BAA80":"DAHAMSATH HARDWARE", "baa891":"VIDUNI H/W", "EMB002":"Pathirana H/w", "EMB005":"Jayashanka H/w", "EMB029":"Dhanapala H/W", "emb033":"Pathirana H/W", "Emb038":"Day Light", "EMB063":"Wickramasinha H/W", "EMB064":"Rakwana H/W", "EMB076":"Priyantha  h/w", "GLE001":"Indrajith Tubewell Works", "HGA003":"RATHNAYAKE HW", "HGA006":"HASHAN H/W", "HGA025":"Rajapaksha Hw", "HGA108":"T.M.Enterprices", "HK28":"LANKA HW - MEE ALLA", "HK29":"A.N.H  H/W", "KIB001":"Sujith H/w", "KOL002":"Junction H/W", "KOL006":"D.G.E AND H/W", "KWA000":"ARPICO CENTER", "KWA0001":"PRADEEP HW", "KWA0002":"PELANWATHTHA HARDWARE", "KWA001":"SARATH HW", "KWA002":"WIJENAYAKE HW", "KWA003":"Dhammika H/W", "KWA009":"MUDALIGE H/W", "kwa010":"Gamage H/W - Galpottayaye", "KWA011":"THILAK HARDWARE", "KWA015":"RANJITH HARDWARE.", "KWA018":"SUJEEWA HARDWARE", "kwa020":"Shehara stors", "KWA022":"RANAWAKA HARDWARE", "KWA025":"SHAN HARDWARE", "KWA026":"ROHANA H/W", "KWA030":"GUNASEKARA HW & STORES", "KWA032":"SAMAGI H/W", "kwa034":"Priyantha Stores", "KWA036":"YASHARA HARDWARE", "KWA045":"UPUL HARDWARE", "KWA046":"MADURANGA STORES", "KWA051":"Gunawardhana H/W", "kwa052":"Thilina H/W", "KWA053":"LALANTHA HW", "KWA082":"Jayans Lanka H/w", "KWA088":"LIYANAGE HW", "kwa102":"GAYAN ELECTRICLE", "kwa128":"A.T Hardware", "KWA13":"SASANDI MULTY TRADERS", "kwa202":"GUNAWARDHANA HW & TOOLS", "kwa222":"RUPASINGHE HW", "KWA321":"DINU CONCREET WORKS & HW", "kwa346":"Rathnaweera H/w", "KWA55":"RATHNA STORES", "kwa555":"CASH CUSTOMER", "KWA65":"JAYA LANKA HARDWARE - KEKIRIOBADA", "KWA666":"THARINDU H/W", "KWA879":"BANDARA H/W", "MDA001":"DASA PICTURE PALACE", "MDA006":"MATARA HW", "MDA010":"ABEYWARNA STORES", "MDA012":"SITHUMINI STORES", "MDA017":"SHASHI CONCRETE& H/W", "MDA026":"RAMANAYAKE HARDWARE", "MDA032":"Anura Tool Mart", "MDA038":"EKANAYAKE STORES", "MDA044":"S.K.H/W", "MDA048":"ABEYWARNA STORES (NOT USE)", "MDA051":"SISIRA STORES", "MDA056":"GARUSINGHE HARDWARE", "MDA100":"RASHENI HARDWARE", "MDA102":"WIJESEKARA HARDWARE", "MDA147":"New Hettiarachchi H/w", "mda199":"SAVINDU FURNITURE HOUSE", "MDA208":"R.M.H/W", "MDA222":"MUNASINGHE SUPER CITY  & HW", "MDA345":"W GAMAGE PAINT HOUSE", "MDA444":"KEMPANE H/W", "MDA528":"Nadeeshani H/w", "MDA94":"MILAN HARDWARE & MULTY SHOP", "MDP001":"Demika H/W", "MDP002":"Alpitiya H/w", "MDP005":"Y.U.S. H/W", "PDN002":"Priyanga Traders", "PLB003":"SAMAGI H/W", "PNMR003":"Panamura  H/w", "PNMR015":"Shan H/W", "RAK005":"New Heshan H/w", "RNA002":"VIJITHA HW", "RNA008":"BEZIL HW", "RNA011":"WELIGAMA ELECTRICALS & HARDWARE", "RNA032":"LAKEESHA FURNTURE", "rna033":"Sohoyuro Enterprices", "RNA055":"RATHNA HARDWARE", "RNA20":"Amarasinghe H/W", "Rna208":"SOHOYURO HW (RANNA TOWN)", "RNA56":"RATHNA HW", "RNA789":"UDAYA ELECTRICAL", "SRW006":"Premachandra  H/w", "SWG001":"Shashimal H/W", "TGA001":"WIJESOORIYA HW", "TGA003":"AL-FAHAD HW", "TGA008":"AMILA HARDWARE", "TGA011":"SITINAMALUWA HW", "TGA022":"CHANDANA STORES", "tga039":"PRESTIGE HOMES & POOL BUILDERS", "TGA040":"RESANDI HARDWARE", "TGA048":"KUMUDU HARDWARE", "TGA062":"LAKMINI H/W", "TGA1400":"ABAYA STORES", "TGA199":"New muthumala H/w", "TGA200":"R.N  H/W", "TGA28":"JAYAWARDANA H/W", "TGA90":"PREMASIRI", "UDW001":"U.G.H/w", "WKA004":"CHAMICA STORES", "WKA005":"RAJAPAKSHA ELECTRICALS & HW", "WKA009":"AMBEPITIYA HW", "wka0120":"Rantharu HW", "WKA013":"TISAKUTTI WELANDASELA", "WKA020":"VIJAYA H/W", "WKA021":"SINGITHI GROCERY", "WKA022":"MAHINDA HARDWARE", "WKA024":"NTG HARDWARE", "WKA0251":"GOLDEN   Water", "WKA026":"K-MARK ELECTRICAL", "WKA028":"SANUSHI  H/W", "wka033":"Deshani H/w", "WKA038":"HETTIARACHCHI HARDWARE", "wka039":"New Weerakatiya H/w", "WKA041":"JAYAWICKRAMA HARDWARE", "WKA044":"W.R.G.HARDWARE", "WKA056":"JAYASIRI H/W", "wka059":"lakmal enterprices", "WKA100":"PRABATH CONSTRUCTION", "wka122":"RUWAN PATHIRANA H/W", "wka200":"NEW INDIKA H/W", "wka2000":"Pathirana HW", "WKA2001":"WEERASINGHA  H/W", "WKA205":"RAJAPAKSHA  HW", "WKA21":"JAYASINGHE CONCREAT WORKS", "WKA250":"WEERAKATIYA HW", "wka332":"Sampath H/W", "WKA62":"NEW GAGANA STORES", "wka72":"Munasinghe H/W", "wka75":"GARU SIN HW (DEBOKKAWA)", "wka800":"Ramanayaka H/W", "WMA004":"WESTERN HW", "WMA005":"WALASMULLA PICTURE PALACE", "WMA007":"CENTRAL HW", "WMA014":"PKG HARDWARE", "WMA016":"JAYAMALI H/W", "WMA035":"SOUTHERN HARDWARE", "WMA036":"CITY ELECTRICLE", "WMA047":"UDAYAGIRI STORES", "WMA050":"DAYA & SONS", "wma053":"RANASI H/W", "WMA060":"WELIWATHTHA H/W", "WMA061":"PRASANNA STEEL", "WMA064":"JAGATH HARDWARE", "WMA065":"ASIAN HARDWARE", "WMA076":"Hettiarachchi  H/w", "WMA080":"Wijesooriya H/w", "WMA081":"JANAKANTHA H/W", "WMA100":"WELAGEDARA HARDWARE", "WMA101":"RAMSI HARDWARE", "WMA102":"KEKIRIOBADA TEMPLE", "wma113":"Govi Sewa Piyasa - BELIATTE", "wma500":"RAJAPAKSHA HW - HOREWELA", "WMA656":"GAMAGE HW "
    };

    const allData = { ...katuwanaData, ...embilipitiyaData };
    
    // --- Elements ---
    const tip = document.getElementById('tip');
    const messageBox = document.getElementById('message-box');
    const duplicateModal = document.getElementById('duplicate-modal');
    const duplicateModalYesBtn = document.getElementById('modal-yes');
    const duplicateModalNoBtn = document.getElementById('modal-no');
    const removeMarkModal = document.getElementById('remove-mark-modal');
    const removeMarkYesBtn = document.getElementById('remove-yes');
    const removeMarkNoBtn = document.getElementById('remove-no');
    const codesContainer = document.getElementById('codes-container');
    const searchBar = document.getElementById('search-bar');

    // --- State and History ---
    const pastedGroups = [];
    
    const markedItems = new Set(); 
    let isSortedAscending = true; 

    const isKatuwanaCode = (code) => katuwanaData.hasOwnProperty(code);
    const isEmbilipitiyaCode = (code) => embilipitiyaData.hasOwnProperty(code);
    
    const isDuplicate = (code) => {
        for (const group of pastedGroups) {
            for (const item of group.items) {
                if (item.code === code) {
                    return true;
                }
            }
        }
        return false;
    };

    // --- Utility functions ---
    const showDuplicateModal = () => new Promise((resolve) => {
      duplicateModal.classList.remove('hidden');
      const yesHandler = () => { cleanup(); resolve(true); };
      const noHandler  = () => { cleanup(); resolve(false); };
      function cleanup() {
        duplicateModal.classList.add('hidden');
        duplicateModalYesBtn.removeEventListener('click', yesHandler);
        duplicateModalNoBtn.removeEventListener('click', noHandler);
      }
      duplicateModalYesBtn.addEventListener('click', yesHandler);
      duplicateModalNoBtn.addEventListener('click', noHandler);
    });

    const showRemoveMarkModal = () => new Promise((resolve) => {
        removeMarkModal.classList.remove('hidden');
        const yesHandler = () => { cleanup(); resolve(true); };
        const noHandler = () => { cleanup(); resolve(false); };
        function cleanup() {
            removeMarkModal.classList.add('hidden');
            removeMarkYesBtn.removeEventListener('click', yesHandler);
            removeMarkNoBtn.removeEventListener('click', noHandler);
        }
        removeMarkYesBtn.addEventListener('click', yesHandler);
        removeMarkNoBtn.addEventListener('click', noHandler);
    });

    function showMessage(message, type) {
      messageBox.textContent = message;
      messageBox.classList.remove('hidden', 'bg-red-500', 'bg-blue-500', 'bg-green-500');
      if (type === 'error') { messageBox.classList.add('bg-red-500'); }
      else if (type === 'success') { messageBox.classList.add('bg-green-500'); }
      else { messageBox.classList.add('bg-blue-500'); }
    }
    
    function markAsRed(id) {
        if (id) {
            markedItems.add(id);
            renderPage(); 
        }
    }

    function removeMark(id) {
        if (id && markedItems.has(id)) {
            markedItems.delete(id);
            renderPage();
            showMessage("Mark removed!", 'success');
        }
    }

    function copyCodeToClipboard(code, id) {
        try {
            navigator.clipboard.writeText(code).then(() => {
                showMessage("Code copied!", 'blue');
                if (id) {
                   markAsRed(id); 
                }
            }).catch(() => {
                fallbackCopyTextToClipboard(code, id);
            });
        } catch (err) {
            fallbackCopyTextToClipboard(code, id);
        }
    }

    function fallbackCopyTextToClipboard(text, id) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";

      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        const msg = successful ? 'Code copied (fallback)!' : 'Copying failed!';
        showMessage(msg, successful ? 'blue' : 'error');
        if (successful && id) {
             markAsRed(id);
        }
      } catch (err) {
        showMessage('Copying failed!', 'error');
      }

      document.body.removeChild(textArea);
    }
    
    async function processAndAddCode(code) {
        const trimmedCode = code.trim().toUpperCase();
        if (!trimmedCode) {
            showMessage("Code is empty.", 'error');
            return;
        }

        if (isDuplicate(trimmedCode)) {
            const again = await showDuplicateModal();
            if (!again) return;
        }
        
        const uniqueId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const item = { code: trimmedCode, id: uniqueId };

        let itemType;
        if (isKatuwanaCode(trimmedCode)) {
            itemType = 'katuwana';
        } else if (isEmbilipitiyaCode(trimmedCode)) {
            itemType = 'embilipitiya';
        } else {
            itemType = 'other';
        }
        
        const lastGroup = pastedGroups.length > 0 ? pastedGroups[pastedGroups.length - 1] : null;

        if (!lastGroup || lastGroup.type !== itemType) {
            pastedGroups.push({ type: itemType, items: [item] });
        } else {
            lastGroup.items.push(item);
        }

        showMessage("Code added!", 'success');
        renderPage();
    }
    
    function createCodeCard(item) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'p-4 rounded-lg bg-white shadow-sm cursor-pointer code-card';
        itemDiv.dataset.code = item.code;
        itemDiv.dataset.id = item.id;
        
        if (markedItems.has(item.id)) {
            itemDiv.classList.add('marked-red');
        }

        const customerName = allData[item.code];
        itemDiv.innerHTML = customerName 
          ? `<span class="font-semibold text-gray-900">${item.code}</span> - <span class="text-gray-700">${customerName}</span>`
          : `<span class="font-semibold text-gray-900">${item.code}</span>`;

        itemDiv.onclick = (e) => {
            e.stopPropagation();
            copyCodeToClipboard(item.code, item.id);
        };
        
        return itemDiv;
    }
    
    function renderPage() {
        codesContainer.innerHTML = '';
        
        const groupsToShow = isSortedAscending ? [...pastedGroups] : [...pastedGroups].reverse();
    
        groupsToShow.forEach(group => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'bg-gray-100 p-6 rounded-lg shadow-inner';
            
            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold text-gray-700 mb-4 text-center';
            if (group.type === 'katuwana') {
                title.textContent = 'Katuwana Area';
            } else if (group.type === 'embilipitiya') {
                title.textContent = 'Embilipitiya Area';
            } else {
                title.textContent = 'Other Codes';
            }
            sectionDiv.appendChild(title);

            const listDiv = document.createElement('div');
            listDiv.className = 'space-y-4';

            group.items.forEach(item => {
                listDiv.appendChild(createCodeCard(item));
            });
            
            sectionDiv.appendChild(listDiv);
            codesContainer.appendChild(sectionDiv);
        });
    }
    
    // Event Listeners
    document.addEventListener('dblclick', async (e) => {
        const codeCard = e.target.closest('[data-code]');

        if (codeCard) {
            const id = codeCard.dataset.id;
            // Check if the item is already marked
            if (markedItems.has(id)) {
                const confirmRemove = await showRemoveMarkModal();
                if (confirmRemove) {
                    removeMark(id);
                }
            } else {
                const code = codeCard.dataset.code;
                processAndAddCode(code);
            }
            return;
        }
      
        if (e.target.id === 'search-bar') {
            searchBar.value = '';
            searchBar.focus();
            return;
        }

        if (!duplicateModal.classList.contains('hidden') && duplicateModal.contains(e.target)) return;
        if (!removeMarkModal.classList.contains('hidden') && removeMarkModal.contains(e.target)) return;
      
        try {
            const text = await navigator.clipboard.readText();
            await processAndAddCode(text);
        } catch (err) {
            if (!tip.classList.contains('hidden')) { return; }
            tip.classList.remove('hidden');
        }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === ' ') {
        e.preventDefault();
        searchBar.classList.toggle('hidden');
        if (!searchBar.classList.contains('hidden')) {
            searchBar.focus();
        }
      } 
      else if (e.key === 'ArrowUp') {
          isSortedAscending = false;
          renderPage();
          showMessage("Sorted Last-to-First", 'blue');
      } 
      else if (e.key === 'ArrowDown') {
          isSortedAscending = true;
          renderPage();
          showMessage("Sorted First-to-Last", 'blue');
      }
    });

    searchBar.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const searchTerm = searchBar.value;
            if (searchTerm.trim() !== '') {
                processAndAddCode(searchTerm); 
                searchBar.value = ''; 
                searchBar.blur();
                searchBar.classList.add('hidden');
            } else {
                showMessage("Search field is empty.", 'error');
            }
        }
    });

    let lastTouch = 0;
    document.addEventListener('touchend', async (event) => {
        const now = new Date().getTime();
        const delta = now - lastTouch;
        if (delta < 300 && delta > 0) {
            event.preventDefault(); 
            const codeCard = event.target.closest('[data-code]');
            if (codeCard) {
                const code = codeCard.dataset.code;
                processAndAddCode(code);
            } else {
                try {
                  const text = await navigator.clipboard.readText();
                  if (text) {
                    await processAndAddCode(text);
                  } else {
                    showMessage("Clipboard is empty.", 'error');
                  }
                } catch (err) {
                    if (!tip.classList.contains('hidden')) { return; }
                    tip.classList.remove('hidden');
                }
            }
            lastTouch = 0;
        }
        lastTouch = now;
    });

    renderPage();
  </script>
</body>
</html>
